<%
  bool2str = {
    true => 'yes',
    false => 'no'
  }
-%>
#
# This file auto-generated by Puppet. Changes made by hand will be
# automatically over-written on the next Puppet run.
#
# To see available options and notes for the FreeRADIUS LDAP module,
# look in /etc/raddb/mods-available/ldap
#
ldap {
  server = '<%= Array(@server).first %>'
  port = <%= @port %>
  identity = '<%= @identity %>'
  password = '<%= @password %>'
  base_dn = '<%= @base_dn %>'

  update {
    control:Password-With-Header += 'userPassword'
  }

  user {
    base_dn = '<%= @base_dn %>'
    filter = "<%= @user_filter %>"
<% if @user_scope -%>
    scope = '<%= @user_scope %>'
<% end -%>
<% if @user_access_attribute -%>
    access_positive = <%= bool2str[@user_access_positive] %>
    access_attribute = '<%= @user_access_attribute %>'
<% end -%>
  }

  group {
    base_dn = '<%= @base_dn %>'
    filter = "<%= @group_filter %>"
<% if @group_scope -%>
    scope = '<%= @group_scope %>'
<% end -%>
<% if @group_name_attribute -%>
    name_attribute = <%= @group_name_attribute %>
<% end -%>
<% if @group_membership_filter -%>
    membership_filter = "<%= @group_membership_filter %>"
<% end -%>
<% if @group_membership_attribute -%>
    membership_attribute = '<%= @group_membership_attribute %>'
<% end -%>
    cacheable_name = '<%= bool2str[@group_cacheable_name] %>'
    cacheable_dn = '<%= bool2str[@group_cacheable_dn] %>'
  }

  profile {
    filter = "<%= @base_filter %>"
<% if @default_profile -%>
    default = '<%= @default_profile %>'
<% end -%>
<% if @profile_attribute -%>
    attribute = '<%= @profile_attribute %>'
<% end -%>
  }

  client {
    base_dn = '<%= @base_dn %>'
    filter = "<%= @client_filter %>"
<% if @client_scope -%>
    scope = '<%= @client_scope %>'
<% end -%>

    attribute {
      identifier = '<%= @client_attribute_identifier %>'
      secret = '<%= @client_attribute_secret %>'
<% if @client_attribute_shortname -%>
      shortname = '<%= @client_attribute_shortname %>'
<% end -%>
<% if @client_attribute_nas_type -%>
      nas_type = '<%= @client_attribute_nas_type %>'
<% end -%>
<% if @client_attribute_virtual_server -%>
      virtual_server = '<%= @client_attribute_virtual_server %>'
<% end -%>
<% if @client_attribute_require_message_authenticator -%>
      require_message_authenticator = '<%= @client_attribute_require_message_authenticator %>'
<% end -%>
    }
  }

  accounting {
<% if @accounting_content -%>
<%= @accounting_content %>
<% else -%>
    reference = "%{tolower:type.%{Acct-Status-Type}}"

    type {
      start {
        update {
          description := "Online at %S"
        }
      }

      interim-update {
        update {
          description := "Last seen at %S"
        }
      }

      stop {
        update {
          description := "Offline at %S"
        }
      }
    }
<% end -%>
  }

  post-auth {
<% if @post_auth_content -%>
<%= @post_auth_content %>
<% else -%>
    update {
      description := "Authenticated at %S"
    }
<% end -%>
  }

  options {
    dereference = <%= @options_dereference %>
    chase_referrals = <%= bool2str[@options_chase_referrals] %>
    rebind = <%= bool2str[@options_rebind] %>
    res_timeout = <%= @ldap_timeout %>
    srv_timelimit = <%= @ldap_timelimit %>
    net_timeout = <%= @options_net_timeout %>
    idle = <%= @options_idle %>
    probes = <%= @options_probes %>
    interval = <%= @options_interval %>
<% if @ldap_debug -%>
    ldap_debug = <%= @ldap_debug %>
<% end -%>
  }

  tls {
    start_tls = <%= bool2str[@start_tls] %>
<% if @app_pki_ca_dir =~ /\/$/ -%>
    ca_path = <%= @app_pki_ca_dir %>
<% else -%>
    ca_path = <%= @app_pki_ca_dir + '/' %>
<% end -%>
    certificate_file = <%= @app_pki_cert %>
    private_key_file = <%= @app_pki_key %>
    random_file = <%= @random_file %>
    require_cert = '<%= @require_cert %>'
  }

  pool {
    start = <%= @pool_start %>
    min = <%= @pool_min %>
    max = <%= @pool_max %>
    spare = <%= @pool_spare %>
    uses = <%= @pool_uses %>
    retry_delay = <%= @retry_delay %>
    lifetime = <%= @pool_lifetime %>
    idle_timeout = <%= @pool_idle_timeout %>
  }
}
